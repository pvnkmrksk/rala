<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rala - English to Kannada Dictionary</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 0;
            background: white;
            color: #333;
        }
        
        .header {
            text-align: center;
            padding: 60px 20px 40px;
        }
        
        h1 {
            font-size: 48px;
            font-weight: 600;
            color: #000;
            margin: 0 0 16px;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 8px;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .subtitle-line {
            display: block;
            margin-bottom: 4px;
        }
        
        .search-wrapper {
            padding: 0 20px 40px;
        }
        
        .search-container {
            display: flex;
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .lang-selector {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus {
            border-color: #000;
        }
        
        .search-button {
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .search-button:hover {
            background: #333;
        }
        
        .search-button svg {
            width: 20px;
            height: 20px;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .result-card {
            background: white;
            border-radius: 0;
            padding: 20px 0;
            margin-bottom: 0;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .result-card:hover {
            background: #fafafa;
        }
        
        .result-card:last-child {
            border-bottom: none;
        }
        
        .kannada-word {
            font-size: 28px;
            font-weight: 600;
            color: #000;
            margin-bottom: 6px;
        }
        
        .phonetic {
            font-size: 14px;
            color: #999;
            font-style: italic;
            margin-bottom: 12px;
        }
        
        .definition {
            margin-bottom: 8px;
            padding-left: 0;
            border-left: none;
        }
        
        .def-type {
            font-size: 11px;
            color: #666;
            background: #f5f5f5;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 8px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .def-text {
            color: #333;
            line-height: 1.6;
        }
        
        .matched-word {
            background: #fff3cd;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        .synonym-match {
            font-size: 13px;
            color: #999;
            margin-top: 8px;
            font-style: italic;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .stats {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-top: 40px;
            padding: 20px;
        }
        
        .search-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            padding: 12px 0;
        }
        
        .tabs-wrapper {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 20px;
            margin-bottom: 0;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-weight: 500;
        }
        
        .tab.active {
            background: #f5f5f5;
            color: #000;
        }
        
        .tab:hover:not(.active) {
            background: #fafafa;
            color: #000;
        }
        
        .tab.loading {
            opacity: 0.7;
        }
        
        .tab-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        
        .results-container {
            padding: 20px;
        }
        
        .results-section {
            margin-bottom: 40px;
        }
        
        .section-anchor {
            scroll-margin-top: 80px;
        }
        
        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: #000;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .attribution {
            margin-top: 60px;
            padding: 40px 20px;
            text-align: center;
            font-size: 13px;
            color: #999;
            border-top: 1px solid #e0e0e0;
        }
        
        .attribution a {
            color: #000;
            text-decoration: underline;
        }
        
        .attribution a:hover {
            text-decoration: none;
        }
        
        .footer-links {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .footer-links a {
            color: #666;
            text-decoration: none;
        }
        
        .footer-links a:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ರಲ</h1>
        <p class="subtitle">
            <span class="subtitle-line">ಶ್ರೀ. ವಿ. ಕೃಷ್ಣ ಅವರ ಇಂಗ್ಲಿಷ್ - ಕನ್ನಡ ನಿಘಂಟು</span>
            <span class="subtitle-line">"Rala" V. Krishna's English → Kannada dictionary</span>
        </p>
    </div>
    
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading dictionary from GitHub...</p>
        </div>
    </div>
    
    <footer class="attribution">
        <p>
            <strong>Rala (ರಲ)</strong> = Reverse <a href="https://alar.ink" target="_blank">Alar</a> · 
            Dictionary data by <a href="https://alar.ink" target="_blank">V. Krishna</a> · 
            Licensed under <a href="https://opendatacommons.org/licenses/odbl/" target="_blank">ODC-ODbL</a> · 
            <a href="https://github.com/alar-dict/data" target="_blank">Source Data</a>
        </p>
        <div class="footer-links">
            <a href="https://github.com/alar-dict/data">Kannada glossary</a>
            <a href="https://alar.ink">About</a>
        </div>
    </footer>

    <script>
        // Main App
        const YAML_URL = 'https://raw.githubusercontent.com/alar-dict/data/master/alar.yml';
        const DATAMUSE_API = 'https://api.datamuse.com/words';
        
        let dictionary = [];
        let reverseIndex = new Map();
        let allEnglishWords = new Set();
        
        // DOM elements
        const app = document.getElementById('app');
        
        // Initialize
        async function init() {
            try {
                await loadDictionary();
                buildReverseIndex();
                renderApp();
            } catch (error) {
                app.innerHTML = `
                    <div class="status" style="color: #e74c3c;">
                        <p>❌ Failed to load dictionary: ${error.message}</p>
                        <p style="font-size: 14px;">Try refreshing the page or check your internet connection.</p>
                    </div>
                `;
            }
        }
        
        async function loadDictionary() {
            const response = await fetch(YAML_URL);
            if (!response.ok) throw new Error('Failed to fetch dictionary');
            const text = await response.text();
            dictionary = jsyaml.load(text);
            console.log(`Loaded ${dictionary.length} entries`);
        }
        
        function buildReverseIndex() {
            // Build reverse index: English word -> list of Kannada entries
            reverseIndex = new Map();
            
            for (const entry of dictionary) {
                if (!entry.defs) continue;
                
                for (const def of entry.defs) {
                    if (!def.entry) continue;
                    
                    // Extract English words from definition
                    const words = extractWords(def.entry.toLowerCase());
                    
                    for (const word of words) {
                        allEnglishWords.add(word);
                        if (!reverseIndex.has(word)) {
                            reverseIndex.set(word, []);
                        }
                        reverseIndex.get(word).push({
                            kannada: entry.entry,
                            phone: entry.phone,
                            definition: def.entry,
                            type: def.type,
                            head: entry.head
                        });
                    }
                }
            }
            
            console.log(`Built reverse index with ${reverseIndex.size} English words`);
        }
        
        function extractWords(text) {
            // Extract meaningful words (skip common words, punctuation, etc.)
            const stopWords = new Set([
                'a', 'an', 'the', 'is', 'are', 'was', 'were', 'be', 'been', 'being',
                'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could',
                'should', 'may', 'might', 'must', 'shall', 'can', 'need', 'dare',
                'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'up',
                'about', 'into', 'over', 'after', 'or', 'and', 'but', 'if', 'as',
                'etc', 'eg', 'ie', 'cf', 'vs', 'fig', 'esp', 'also', 'see'
            ]);
            
            return text
                .replace(/[^\w\s-]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 2 && !stopWords.has(w) && !/^\d+$/.test(w));
        }
        
        async function getSynonyms(word) {
            try {
                // Get synonyms using Datamuse API
                const response = await fetch(`${DATAMUSE_API}?rel_syn=${encodeURIComponent(word)}&max=15`);
                const data = await response.json();
                return data.map(item => item.word);
            } catch {
                return [];
            }
        }
        
        async function getSimilarWords(word) {
            try {
                // Get words with similar meaning
                const response = await fetch(`${DATAMUSE_API}?ml=${encodeURIComponent(word)}&max=20`);
                const data = await response.json();
                return data.map(item => item.word);
            } catch {
                return [];
            }
        }
        
        function searchDirect(query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const results = [];
            const seen = new Set();
            
            for (const word of words) {
                if (reverseIndex.has(word)) {
                    for (const entry of reverseIndex.get(word)) {
                        const key = `${entry.kannada}-${entry.definition}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ ...entry, matchedWord: word, matchType: 'direct' });
                        }
                    }
                }
            }
            
            return results;
        }
        
        async function searchWithSynonyms(query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const results = [];
            const seen = new Set();
            const synonymsUsed = {};
            
            for (const word of words) {
                // Get synonyms and similar words
                const [synonyms, similar] = await Promise.all([
                    getSynonyms(word),
                    getSimilarWords(word)
                ]);
                
                const relatedWords = [...new Set([...synonyms, ...similar])];
                
                for (const relWord of relatedWords) {
                    if (reverseIndex.has(relWord)) {
                        for (const entry of reverseIndex.get(relWord)) {
                            const key = `${entry.kannada}-${entry.definition}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                if (!synonymsUsed[word]) synonymsUsed[word] = [];
                                if (!synonymsUsed[word].includes(relWord)) {
                                    synonymsUsed[word].push(relWord);
                                }
                                results.push({ 
                                    ...entry, 
                                    matchedWord: relWord, 
                                    originalQuery: word,
                                    matchType: 'synonym' 
                                });
                            }
                        }
                    }
                }
            }
            
            return { results, synonymsUsed };
        }
        
        function highlightMatch(text, word) {
            const regex = new RegExp(`\\b(${word})\\b`, 'gi');
            return text.replace(regex, '<span class="matched-word">$1</span>');
        }
        
        function renderResults(directResults, synonymResults, synonymsUsed, query, loadingDirect = false, loadingIndirect = false) {
            let html = '';
            
            if (directResults.length === 0 && synonymResults.length === 0 && !loadingDirect && !loadingIndirect) {
                return `
                    <div class="no-results">
                        <p>No results found for "${query}"</p>
                        <p style="font-size: 14px; margin-top: 8px;">Try a different word or check spelling</p>
                    </div>
                `;
            }
            
            // Exact matches section
            html += `
                <div class="results-section section-anchor" id="exact-matches">
                    <div class="section-header">Exact Match${directResults.length !== 1 ? 'es' : ''} (${directResults.length})</div>
            `;
            
            if (loadingDirect) {
                html += `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Searching...</p>
                    </div>
                `;
            } else if (directResults.length > 0) {
                html += directResults.map(r => renderResultCard(r, query)).join('');
            } else {
                html += `
                    <div class="no-results">
                        <p>No exact matches found</p>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Synonym matches section
            html += `
                <div class="results-section section-anchor" id="synonym-matches">
                    <div class="section-header">Synonym Match${synonymResults.length !== 1 ? 'es' : ''} (${synonymResults.length})</div>
            `;
            
            if (loadingIndirect) {
                html += `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Searching...</p>
                    </div>
                `;
            } else if (synonymResults.length > 0) {
                const usedSynonyms = Object.entries(synonymsUsed)
                    .map(([orig, syns]) => `"${orig}" → ${syns.slice(0, 5).join(', ')}`)
                    .join('; ');
                    
                html += `
                    <div class="search-info">
                        Found via: ${usedSynonyms}
                    </div>
                `;
                html += synonymResults.map(r => renderResultCard(r, query, true)).join('');
            } else if (!loadingDirect) {
                html += `
                    <div class="no-results">
                        <p>No synonym matches found</p>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        function renderResultCard(result, query, isSynonym = false) {
            const highlightedDef = highlightMatch(result.definition, result.matchedWord);
            
            return `
                <div class="result-card">
                    <div class="kannada-word">${result.kannada}</div>
                    <div class="phonetic">${result.phone || ''}</div>
                    <div class="definition">
                        <span class="def-type">${result.type || 'n/a'}</span>
                        <span class="def-text">${highlightedDef}</span>
                    </div>
                    ${isSynonym ? `<div class="synonym-match">matched via synonym: "${result.matchedWord}" (searched: "${result.originalQuery}")</div>` : ''}
                </div>
            `;
        }
        
        function renderApp() {
            app.innerHTML = `
                <div class="search-wrapper">
                    <div class="search-container">
                        <div class="lang-selector">
                            <span>English - Kannada</span>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h6M6 3l3 3-3 3"/>
                            </svg>
                        </div>
                        <input type="text" id="search-input" placeholder="Search English word..." autofocus>
                        <button class="search-button" id="search-button">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="tabs-wrapper" id="tabs-wrapper" style="display: none;">
                    <div class="tabs">
                        <button class="tab active" id="tab-exact">
                            <span>Exact Match</span>
                            <span id="tab-exact-count"></span>
                            <span id="tab-exact-spinner" class="tab-spinner" style="display: none;"></span>
                        </button>
                        <button class="tab" id="tab-synonym">
                            <span>Synonym Match</span>
                            <span id="tab-synonym-count"></span>
                            <span id="tab-synonym-spinner" class="tab-spinner" style="display: none;"></span>
                        </button>
                    </div>
                </div>
                <div id="results" class="results-container"></div>
                <div class="stats">
                    ${dictionary.length.toLocaleString()} Kannada entries | 
                    ${reverseIndex.size.toLocaleString()} unique English words indexed
                </div>
            `;
            
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const resultsDiv = document.getElementById('results');
            const tabsWrapper = document.getElementById('tabs-wrapper');
            const tabExact = document.getElementById('tab-exact');
            const tabSynonym = document.getElementById('tab-synonym');
            const tabExactCount = document.getElementById('tab-exact-count');
            const tabSynonymCount = document.getElementById('tab-synonym-count');
            const tabExactSpinner = document.getElementById('tab-exact-spinner');
            const tabSynonymSpinner = document.getElementById('tab-synonym-spinner');
            
            let directResults = [];
            let synonymResults = [];
            let synonymsUsed = {};
            let currentQuery = '';
            let debounceTimer = null;
            let synonymSearchInProgress = false;
            let synonymSearchCompleted = false;
            let synonymSearchTimeout = null;
            
            function switchTab(tabName) {
                if (tabName === 'exact') {
                    tabExact.classList.add('active');
                    tabSynonym.classList.remove('active');
                    const exactSection = document.getElementById('exact-matches');
                    if (exactSection) {
                        setTimeout(() => {
                            exactSection.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }, 100);
                    }
                } else {
                    tabSynonym.classList.add('active');
                    tabExact.classList.remove('active');
                    const synonymSection = document.getElementById('synonym-matches');
                    if (synonymSection) {
                        setTimeout(() => {
                            synonymSection.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }, 100);
                    }
                }
            }
            
            tabExact.addEventListener('click', () => switchTab('exact'));
            tabSynonym.addEventListener('click', () => switchTab('synonym'));
            searchButton.addEventListener('click', () => {
                if (searchInput.value.trim()) {
                    performSearch(searchInput.value.trim(), true);
                }
            });
            
            async function loadSynonyms(query) {
                if (synonymSearchInProgress || synonymSearchCompleted) {
                    return;
                }
                
                synonymSearchInProgress = true;
                tabSynonymSpinner.style.display = 'inline-block';
                
                const { results: synonymResultsTemp, synonymsUsed: synonymsUsedTemp } = await searchWithSynonyms(query);
                
                // Filter out synonym results that are already in direct results
                const directKeys = new Set(directResults.map(r => `${r.kannada}-${r.definition}`));
                synonymResults = synonymResultsTemp.filter(r => 
                    !directKeys.has(`${r.kannada}-${r.definition}`)
                );
                synonymsUsed = synonymsUsedTemp;
                
                tabSynonymCount.textContent = ` (${synonymResults.length})`;
                tabSynonymSpinner.style.display = 'none';
                synonymSearchCompleted = true;
                
                // Update UI with both results
                resultsDiv.innerHTML = renderResults(directResults, synonymResults, synonymsUsed, query, false, false);
            }
            
            async function performSearch(query, fromEnter = false) {
                if (!query.trim()) {
                    resultsDiv.innerHTML = '';
                    tabsWrapper.style.display = 'none';
                    directResults = [];
                    synonymResults = [];
                    synonymsUsed = {};
                    currentQuery = '';
                    synonymSearchInProgress = false;
                    synonymSearchCompleted = false;
                    if (synonymSearchTimeout) {
                        clearTimeout(synonymSearchTimeout);
                        synonymSearchTimeout = null;
                    }
                    return;
                }
                
                currentQuery = query;
                directResults = [];
                synonymResults = [];
                synonymsUsed = {};
                synonymSearchInProgress = false;
                synonymSearchCompleted = false;
                
                // Clear any pending synonym search
                if (synonymSearchTimeout) {
                    clearTimeout(synonymSearchTimeout);
                    synonymSearchTimeout = null;
                }
                
                // Show tabs
                tabsWrapper.style.display = 'block';
                
                // Reset tab states
                tabExactCount.textContent = '';
                tabSynonymCount.textContent = '';
                tabExactSpinner.style.display = 'inline-block';
                tabSynonymSpinner.style.display = 'none';
                
                // Show loading state for direct matches
                resultsDiv.innerHTML = renderResults([], [], {}, query, true, false);
                switchTab('exact');
                
                // Step 1: Search direct matches
                directResults = searchDirect(query);
                tabExactCount.textContent = ` (${directResults.length})`;
                tabExactSpinner.style.display = 'none';
                
                // Update UI with direct results
                resultsDiv.innerHTML = renderResults(directResults, [], {}, query, false, false);
                
                // Step 2: Load synonyms with delay (500ms) or immediately if Enter was pressed
                if (fromEnter) {
                    // Load immediately if Enter was pressed
                    await loadSynonyms(query);
                } else {
                    // Wait 500ms before loading synonyms
                    synonymSearchTimeout = setTimeout(() => {
                        loadSynonyms(query);
                    }, 500);
                }
                
                // Hide tabs if no results at all
                if (directResults.length === 0 && synonymResults.length === 0) {
                    tabsWrapper.style.display = 'none';
                } else {
                    // Default to exact tab
                    switchTab('exact');
                }
            }
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    performSearch(e.target.value, false);
                }, 300);
            });
            
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    clearTimeout(debounceTimer);
                    const query = e.target.value.trim();
                    
                    // If query changed, perform new search
                    if (query !== currentQuery) {
                        performSearch(query, true);
                    } else if (!synonymSearchCompleted && !synonymSearchInProgress && currentQuery) {
                        // If synonyms haven't loaded yet, load them now
                        if (synonymSearchTimeout) {
                            clearTimeout(synonymSearchTimeout);
                            synonymSearchTimeout = null;
                        }
                        loadSynonyms(currentQuery);
                    }
                }
            });
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
