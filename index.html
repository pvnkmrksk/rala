<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rala - English to Kannada Dictionary</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus {
            border-color: #3498db;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .results-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: box-shadow 0.2s;
        }
        
        .result-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .kannada-word {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .phonetic {
            font-size: 14px;
            color: #95a5a6;
            font-style: italic;
            margin-bottom: 12px;
        }
        
        .definition {
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 3px solid #e8e8e8;
        }
        
        .def-type {
            font-size: 11px;
            color: #fff;
            background: #3498db;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 8px;
            text-transform: uppercase;
        }
        
        .def-text {
            color: #444;
            line-height: 1.5;
        }
        
        .matched-word {
            background: #fff3cd;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        .synonym-match {
            font-size: 12px;
            color: #e67e22;
            margin-top: 8px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .stats {
            text-align: center;
            font-size: 13px;
            color: #95a5a6;
            margin-top: 8px;
        }
        
        .search-info {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 16px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            padding: 8px 16px;
            border: none;
            background: #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #d0d0d0;
        }
        
        .tab.loading {
            opacity: 0.7;
        }
        
        .tab-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        
        .results-container {
            min-height: 200px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .attribution {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            font-size: 13px;
            color: #7f8c8d;
            border-top: 1px solid #e0e0e0;
        }
        
        .attribution a {
            color: #3498db;
            text-decoration: none;
        }
        
        .attribution a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>üìñ Rala (‡≤∞‡≤≤)</h1>
    <p class="subtitle">English ‚Üí Kannada ‡≤∂‡≤¨‡≥ç‡≤¶‡≤ï‡≥ã‡≤∂ (uneducated reverse dictionary)</p>
    
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading dictionary from GitHub...</p>
        </div>
    </div>
    
    <footer class="attribution">
        <p>
            <strong>Rala (‡≤∞‡≤≤)</strong> = Reverse <a href="https://alar.ink" target="_blank">Alar</a> ¬∑ 
            Dictionary data by <a href="https://alar.ink" target="_blank">V. Krishna</a> ¬∑ 
            Licensed under <a href="https://opendatacommons.org/licenses/odbl/" target="_blank">ODC-ODbL</a> ¬∑ 
            <a href="https://github.com/alar-dict/data" target="_blank">Source Data</a>
        </p>
    </footer>

    <script>
        // Main App
        const YAML_URL = 'https://raw.githubusercontent.com/alar-dict/data/master/alar.yml';
        const DATAMUSE_API = 'https://api.datamuse.com/words';
        
        let dictionary = [];
        let reverseIndex = new Map();
        let allEnglishWords = new Set();
        
        // DOM elements
        const app = document.getElementById('app');
        
        // Initialize
        async function init() {
            try {
                await loadDictionary();
                buildReverseIndex();
                renderApp();
            } catch (error) {
                app.innerHTML = `
                    <div class="status" style="color: #e74c3c;">
                        <p>‚ùå Failed to load dictionary: ${error.message}</p>
                        <p style="font-size: 14px;">Try refreshing the page or check your internet connection.</p>
                    </div>
                `;
            }
        }
        
        async function loadDictionary() {
            const response = await fetch(YAML_URL);
            if (!response.ok) throw new Error('Failed to fetch dictionary');
            const text = await response.text();
            dictionary = jsyaml.load(text);
            console.log(`Loaded ${dictionary.length} entries`);
        }
        
        function buildReverseIndex() {
            // Build reverse index: English word -> list of Kannada entries
            reverseIndex = new Map();
            
            for (const entry of dictionary) {
                if (!entry.defs) continue;
                
                for (const def of entry.defs) {
                    if (!def.entry) continue;
                    
                    // Extract English words from definition
                    const words = extractWords(def.entry.toLowerCase());
                    
                    for (const word of words) {
                        allEnglishWords.add(word);
                        if (!reverseIndex.has(word)) {
                            reverseIndex.set(word, []);
                        }
                        reverseIndex.get(word).push({
                            kannada: entry.entry,
                            phone: entry.phone,
                            definition: def.entry,
                            type: def.type,
                            head: entry.head
                        });
                    }
                }
            }
            
            console.log(`Built reverse index with ${reverseIndex.size} English words`);
        }
        
        function extractWords(text) {
            // Extract meaningful words (skip common words, punctuation, etc.)
            const stopWords = new Set([
                'a', 'an', 'the', 'is', 'are', 'was', 'were', 'be', 'been', 'being',
                'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could',
                'should', 'may', 'might', 'must', 'shall', 'can', 'need', 'dare',
                'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'up',
                'about', 'into', 'over', 'after', 'or', 'and', 'but', 'if', 'as',
                'etc', 'eg', 'ie', 'cf', 'vs', 'fig', 'esp', 'also', 'see'
            ]);
            
            return text
                .replace(/[^\w\s-]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 2 && !stopWords.has(w) && !/^\d+$/.test(w));
        }
        
        async function getSynonyms(word) {
            try {
                // Get synonyms using Datamuse API
                const response = await fetch(`${DATAMUSE_API}?rel_syn=${encodeURIComponent(word)}&max=15`);
                const data = await response.json();
                return data.map(item => item.word);
            } catch {
                return [];
            }
        }
        
        async function getSimilarWords(word) {
            try {
                // Get words with similar meaning
                const response = await fetch(`${DATAMUSE_API}?ml=${encodeURIComponent(word)}&max=20`);
                const data = await response.json();
                return data.map(item => item.word);
            } catch {
                return [];
            }
        }
        
        function searchDirect(query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const results = [];
            const seen = new Set();
            
            for (const word of words) {
                if (reverseIndex.has(word)) {
                    for (const entry of reverseIndex.get(word)) {
                        const key = `${entry.kannada}-${entry.definition}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ ...entry, matchedWord: word, matchType: 'direct' });
                        }
                    }
                }
            }
            
            return results;
        }
        
        async function searchWithSynonyms(query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const results = [];
            const seen = new Set();
            const synonymsUsed = {};
            
            for (const word of words) {
                // Get synonyms and similar words
                const [synonyms, similar] = await Promise.all([
                    getSynonyms(word),
                    getSimilarWords(word)
                ]);
                
                const relatedWords = [...new Set([...synonyms, ...similar])];
                
                for (const relWord of relatedWords) {
                    if (reverseIndex.has(relWord)) {
                        for (const entry of reverseIndex.get(relWord)) {
                            const key = `${entry.kannada}-${entry.definition}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                if (!synonymsUsed[word]) synonymsUsed[word] = [];
                                if (!synonymsUsed[word].includes(relWord)) {
                                    synonymsUsed[word].push(relWord);
                                }
                                results.push({ 
                                    ...entry, 
                                    matchedWord: relWord, 
                                    originalQuery: word,
                                    matchType: 'synonym' 
                                });
                            }
                        }
                    }
                }
            }
            
            return { results, synonymsUsed };
        }
        
        function highlightMatch(text, word) {
            const regex = new RegExp(`\\b(${word})\\b`, 'gi');
            return text.replace(regex, '<span class="matched-word">$1</span>');
        }
        
        function renderResults(directResults, synonymResults, synonymsUsed, query, loadingDirect = false, loadingIndirect = false) {
            let html = '';
            
            // Direct matches tab content
            html += `
                <div class="tab-content ${directResults.length > 0 || loadingDirect ? 'active' : ''}" id="tab-content-direct">
            `;
            
            if (loadingDirect) {
                html += `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Searching direct matches...</p>
                    </div>
                `;
            } else if (directResults.length > 0) {
                html += `
                    <div class="results-section">
                        ${directResults.map(r => renderResultCard(r, query)).join('')}
                    </div>
                `;
            } else if (!loadingIndirect) {
                html += `
                    <div class="no-results">
                        <p>üòï No direct matches found for "${query}"</p>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Indirect/synonym matches tab content
            html += `
                <div class="tab-content ${directResults.length === 0 && (synonymResults.length > 0 || loadingIndirect) ? 'active' : ''}" id="tab-content-indirect">
            `;
            
            if (loadingIndirect) {
                html += `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Searching indirect matches...</p>
                    </div>
                `;
            } else if (synonymResults.length > 0) {
                const usedSynonyms = Object.entries(synonymsUsed)
                    .map(([orig, syns]) => `"${orig}" ‚Üí ${syns.slice(0, 5).join(', ')}`)
                    .join('; ');
                    
                html += `
                    <div class="search-info">
                        üîó Found via: ${usedSynonyms}
                    </div>
                    <div class="results-section">
                        ${synonymResults.map(r => renderResultCard(r, query, true)).join('')}
                    </div>
                `;
            } else if (!loadingDirect) {
                html += `
                    <div class="no-results">
                        <p>üòï No indirect matches found for "${query}"</p>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            if (directResults.length === 0 && synonymResults.length === 0 && !loadingDirect && !loadingIndirect) {
                html = `
                    <div class="no-results">
                        <p>üòï No results found for "${query}"</p>
                        <p style="font-size: 14px;">Try a different word or check spelling</p>
                    </div>
                `;
            }
            
            return html;
        }
        
        function renderResultCard(result, query, isSynonym = false) {
            const highlightedDef = highlightMatch(result.definition, result.matchedWord);
            
            return `
                <div class="result-card">
                    <div class="kannada-word">${result.kannada}</div>
                    <div class="phonetic">${result.phone || ''}</div>
                    <div class="definition">
                        <span class="def-type">${result.type || 'n/a'}</span>
                        <span class="def-text">${highlightedDef}</span>
                    </div>
                    ${isSynonym ? `<div class="synonym-match">‚Ü≥ matched via synonym: "${result.matchedWord}" (searched: "${result.originalQuery}")</div>` : ''}
                </div>
            `;
        }
        
        function renderApp() {
            app.innerHTML = `
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search English word (e.g., happy, water, beautiful)..." autofocus>
                </div>
                <div class="tabs" id="tabs-container" style="display: none;">
                    <button class="tab active" id="tab-direct">
                        <span>DIRECT MATCHES</span>
                        <span id="tab-direct-count"></span>
                        <span id="tab-direct-spinner" class="tab-spinner" style="display: none;"></span>
                    </button>
                    <button class="tab" id="tab-indirect">
                        <span>Synonym/Indirect Matches</span>
                        <span id="tab-indirect-count"></span>
                        <span id="tab-indirect-spinner" class="tab-spinner" style="display: none;"></span>
                    </button>
                </div>
                <div id="results" class="results-container"></div>
                <div class="stats">
                    üìö ${dictionary.length.toLocaleString()} Kannada entries | 
                    üî§ ${reverseIndex.size.toLocaleString()} unique English words indexed
                </div>
            `;
            
            const searchInput = document.getElementById('search-input');
            const resultsDiv = document.getElementById('results');
            const tabsContainer = document.getElementById('tabs-container');
            const tabDirect = document.getElementById('tab-direct');
            const tabIndirect = document.getElementById('tab-indirect');
            const tabDirectCount = document.getElementById('tab-direct-count');
            const tabIndirectCount = document.getElementById('tab-indirect-count');
            const tabDirectSpinner = document.getElementById('tab-direct-spinner');
            const tabIndirectSpinner = document.getElementById('tab-indirect-spinner');
            
            let directResults = [];
            let synonymResults = [];
            let synonymsUsed = {};
            let currentQuery = '';
            let debounceTimer = null;
            let synonymSearchInProgress = false;
            let synonymSearchCompleted = false;
            let synonymSearchTimeout = null;
            
            function scrollToResults() {
                setTimeout(() => {
                    // Scroll to the results section
                    resultsDiv.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
            
            function switchTab(tabName, shouldScroll = true) {
                if (tabName === 'direct') {
                    tabDirect.classList.add('active');
                    tabIndirect.classList.remove('active');
                    document.getElementById('tab-content-direct')?.classList.add('active');
                    document.getElementById('tab-content-indirect')?.classList.remove('active');
                } else {
                    tabIndirect.classList.add('active');
                    tabDirect.classList.remove('active');
                    document.getElementById('tab-content-indirect')?.classList.add('active');
                    document.getElementById('tab-content-direct')?.classList.remove('active');
                }
                if (shouldScroll) {
                    scrollToResults();
                }
            }
            
            tabDirect.addEventListener('click', () => switchTab('direct'));
            tabIndirect.addEventListener('click', () => switchTab('indirect'));
            
            async function performSearch(query) {
                if (!query.trim()) {
                    resultsDiv.innerHTML = '';
                    tabsContainer.style.display = 'none';
                    directResults = [];
                    synonymResults = [];
                    synonymsUsed = {};
                    currentQuery = '';
                    return;
                }
                
                currentQuery = query;
                directResults = [];
                synonymResults = [];
                synonymsUsed = {};
                
                // Show tabs
                tabsContainer.style.display = 'flex';
                
                // Reset tab states
                tabDirectCount.textContent = '';
                tabIndirectCount.textContent = '';
                tabDirectSpinner.style.display = 'inline-block';
                tabIndirectSpinner.style.display = 'none';
                
                // Show loading state for direct matches
                resultsDiv.innerHTML = renderResults([], [], {}, query, true, false);
                switchTab('direct');
                
                // Step 1: Search direct matches
                directResults = searchDirect(query);
                tabDirectCount.textContent = `(${directResults.length})`;
                tabDirectSpinner.style.display = 'none';
                
                // Update UI with direct results
                resultsDiv.innerHTML = renderResults(directResults, [], {}, query, false, true);
                switchTab('direct');
                
                // Step 2: Search indirect matches (after direct finishes)
                tabIndirectSpinner.style.display = 'inline-block';
                
                const { results: synonymResultsTemp, synonymsUsed: synonymsUsedTemp } = await searchWithSynonyms(query);
                
                // Filter out synonym results that are already in direct results
                const directKeys = new Set(directResults.map(r => `${r.kannada}-${r.definition}`));
                synonymResults = synonymResultsTemp.filter(r => 
                    !directKeys.has(`${r.kannada}-${r.definition}`)
                );
                synonymsUsed = synonymsUsedTemp;
                
                tabIndirectCount.textContent = `(${synonymResults.length})`;
                tabIndirectSpinner.style.display = 'none';
                
                // Update UI with both results
                resultsDiv.innerHTML = renderResults(directResults, synonymResults, synonymsUsed, query, false, false);
                
                // Hide tabs if no results at all
                if (directResults.length === 0 && synonymResults.length === 0) {
                    tabsContainer.style.display = 'none';
                } else {
                    // If no direct results, switch to indirect tab
                    if (directResults.length === 0 && synonymResults.length > 0) {
                        switchTab('indirect');
                    } else {
                        switchTab('direct');
                    }
                }
            }
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    performSearch(e.target.value);
                }, 300);
            });
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
